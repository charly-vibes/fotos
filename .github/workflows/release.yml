name: Release

on:
  push:
    tags: ["v*"]

env:
  CARGO_TERM_COLOR: always

# ── fotos-mcp: build binaries on each platform, release via goreleaser ─────────

jobs:
  mcp-linux:
    name: Build fotos-mcp (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu,aarch64-unknown-linux-gnu

      - uses: Swatinem/rust-cache@v2
        with:
          key: mcp-linux

      - name: Install aarch64 cross-compile toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build Linux binaries
        run: |
          cargo build --release --manifest-path src-mcp/Cargo.toml --target x86_64-unknown-linux-gnu
          cargo build --release --manifest-path src-mcp/Cargo.toml --target aarch64-unknown-linux-gnu
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc

      - name: Collect prebuilt binaries
        run: |
          mkdir -p prebuilt/linux_amd64 prebuilt/linux_arm64
          cp src-mcp/target/x86_64-unknown-linux-gnu/release/fotos-mcp prebuilt/linux_amd64/fotos-mcp
          cp src-mcp/target/aarch64-unknown-linux-gnu/release/fotos-mcp prebuilt/linux_arm64/fotos-mcp

      - uses: actions/upload-artifact@v4
        with:
          name: mcp-prebuilt-linux
          path: prebuilt/
          retention-days: 1

  mcp-darwin:
    name: Build fotos-mcp (macOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - uses: Swatinem/rust-cache@v2
        with:
          key: mcp-darwin

      - name: Build macOS binaries
        run: |
          cargo build --release --manifest-path src-mcp/Cargo.toml --target x86_64-apple-darwin
          cargo build --release --manifest-path src-mcp/Cargo.toml --target aarch64-apple-darwin

      - name: Collect prebuilt binaries
        run: |
          mkdir -p prebuilt/darwin_amd64 prebuilt/darwin_arm64
          cp src-mcp/target/x86_64-apple-darwin/release/fotos-mcp prebuilt/darwin_amd64/fotos-mcp
          cp src-mcp/target/aarch64-apple-darwin/release/fotos-mcp prebuilt/darwin_arm64/fotos-mcp

      - uses: actions/upload-artifact@v4
        with:
          name: mcp-prebuilt-darwin
          path: prebuilt/
          retention-days: 1

  mcp-windows:
    name: Build fotos-mcp (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - uses: Swatinem/rust-cache@v2
        with:
          key: mcp-windows

      - name: Build Windows binary
        run: cargo build --release --manifest-path src-mcp/Cargo.toml --target x86_64-pc-windows-msvc

      - name: Collect prebuilt binaries
        shell: bash
        run: |
          mkdir -p prebuilt/windows_amd64
          cp src-mcp/target/x86_64-pc-windows-msvc/release/fotos-mcp.exe prebuilt/windows_amd64/fotos-mcp.exe

      - uses: actions/upload-artifact@v4
        with:
          name: mcp-prebuilt-windows
          path: prebuilt/
          retention-days: 1

# ── fotos desktop app: Tauri builds ───────────────────────────────────────────

  build-linux:
    name: Build fotos (Linux)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev libwebkit2gtk-4.1-dev libjavascriptcoregtk-4.1-dev \
            libsoup-3.0-dev libcairo2-dev libpango1.0-dev libgdk-pixbuf-2.0-dev \
            libatk1.0-dev libappindicator3-dev libdbus-1-dev libpipewire-0.3-dev \
            libclang-dev libssl-dev libtesseract-dev libleptonica-dev \
            librsvg2-dev libgbm-dev

      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Install tauri-cli
        run: cargo install tauri-cli --locked

      - name: Install just
        run: cargo install just --locked

      - name: Build package
        run: just package deb

      - uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: src-tauri/target/release/bundle/deb/*.deb

      - uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: src-tauri/target/release/bundle/appimage/*.AppImage

  build-windows:
    name: Build fotos (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Install LLVM and Clang
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: "17"

      - name: Install tesseract via vcpkg
        run: |
          vcpkg install tesseract:x64-windows-static-md leptonica:x64-windows-static-md
        env:
          VCPKG_ROOT: C:\vcpkg

      - name: Install tauri-cli
        run: cargo install tauri-cli --locked

      - name: Install just
        run: cargo install just --locked

      - name: Build package
        run: just package msi
        env:
          VCPKG_ROOT: C:\vcpkg
          TESSERACT_PREFIX: C:\vcpkg\installed\x64-windows-static-md

      - uses: actions/upload-artifact@v4
        with:
          name: windows-msi
          path: src-tauri/target/release/bundle/msi/*.msi

      - uses: actions/upload-artifact@v4
        with:
          name: windows-nsis
          path: src-tauri/target/release/bundle/nsis/*.exe

# ── publish: build GitHub release, update tap/bucket ──────────────────────────

  release:
    name: Publish Release
    needs:
      - mcp-linux
      - mcp-darwin
      - mcp-windows
      - build-linux
      - build-windows
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          path: artifacts/

      # Assemble prebuilt MCP binaries for goreleaser
      - name: Prepare prebuilt binaries
        run: |
          mkdir -p prebuilt
          cp -r artifacts/mcp-prebuilt-linux/* prebuilt/ 2>/dev/null || true
          cp -r artifacts/mcp-prebuilt-darwin/* prebuilt/ 2>/dev/null || true
          cp -r artifacts/mcp-prebuilt-windows/* prebuilt/ 2>/dev/null || true

      - uses: goreleaser/goreleaser-action@v6
        with:
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}

      # Upload Tauri desktop app assets to the same GitHub release
      - name: Upload desktop app assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/linux-deb/*.deb
            artifacts/linux-appimage/*.AppImage
            artifacts/windows-msi/*.msi
            artifacts/windows-nsis/*.exe

      # Update Homebrew cask for the fotos desktop app
      - name: Update Homebrew cask (fotos)
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          APPIMAGE=$(ls artifacts/linux-appimage/*.AppImage | head -1)
          APPIMAGE_SHA=$(sha256sum "$APPIMAGE" | awk '{print $1}')

          git clone "https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/charly-vibes/homebrew-charly.git" /tmp/homebrew-charly

          cat > /tmp/homebrew-charly/Casks/fotos.rb << CASK
          cask "fotos" do
            version "${VERSION}"

            on_linux do
              url "https://github.com/charly-vibes/fotos/releases/download/v${VERSION}/fotos_${VERSION}_amd64.AppImage"
              sha256 "${APPIMAGE_SHA}"
            end

            on_macos do
              url "https://github.com/charly-vibes/fotos/releases/download/v${VERSION}/fotos_${VERSION}_x64.dmg"
              sha256 :no_check
            end

            name "Fotos"
            desc "AI-powered screenshot capture and analysis tool"
            homepage "https://github.com/charly-vibes/fotos"

            on_linux do
              binary "fotos_#{version}_amd64.AppImage", target: "fotos"
            end

            on_macos do
              app "Fotos.app"
            end

            zap trash: [
              "~/.config/fotos",
              "~/.local/share/fotos",
              "~/Library/Application Support/fotos",
              "~/Library/Caches/fotos",
              "~/Library/Preferences/io.github.charly.fotos.plist",
            ]
          end
          CASK

          cd /tmp/homebrew-charly
          git config user.email "noreply@github.com"
          git config user.name "GitHub Actions"
          git add Casks/fotos.rb
          git diff --cached --quiet || git commit -m "chore: update fotos cask to ${VERSION}"
          git push

      # Update Scoop manifest for the fotos desktop app
      - name: Update Scoop manifest (fotos)
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          MSI=$(ls artifacts/windows-msi/*.msi | head -1)
          MSI_SHA=$(sha256sum "$MSI" | awk '{print $1}')

          git clone "https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/charly-vibes/scoop-charly.git" /tmp/scoop-charly

          jq \
            --arg v "$VERSION" \
            --arg hash "sha256:$MSI_SHA" \
            --arg url "https://github.com/charly-vibes/fotos/releases/download/v${VERSION}/fotos_${VERSION}_x64_en-US.msi" \
            '.version = $v | .hash = $hash | .url = $url | .autoupdate.url = "https://github.com/charly-vibes/fotos/releases/download/v$version/fotos_$version_x64_en-US.msi"' \
            /tmp/scoop-charly/bucket/fotos.json > /tmp/fotos-updated.json
          mv /tmp/fotos-updated.json /tmp/scoop-charly/bucket/fotos.json

          cd /tmp/scoop-charly
          git config user.email "noreply@github.com"
          git config user.name "GitHub Actions"
          git add bucket/fotos.json
          git diff --cached --quiet || git commit -m "chore: update fotos to ${VERSION}"
          git push

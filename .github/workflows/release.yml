# Release workflow - build cross-platform binaries and publish a GitHub release
#
# Triggered by pushing a version tag (e.g., `git tag v0.1.0 && git push --tags`).
# Creates a GitHub Release with:
#   - fotos-mcp MCP server binaries for Linux, macOS, and Windows
#   - fotos desktop app packages (Linux .deb/.AppImage, Windows .msi/.exe)
# Then auto-updates homebrew-charly and scoop-charly for both fotos-mcp and fotos.
#
# Required secrets:
#   GITHUB_TOKEN       - automatically provided by GitHub Actions
#   TAP_GITHUB_TOKEN   - PAT with repo write access to homebrew-charly and scoop-charly

name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

# ── fotos-mcp: build binaries on each platform ────────────────────────────────

jobs:
  mcp-linux:
    name: Build fotos-mcp (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu,aarch64-unknown-linux-gnu

      - uses: Swatinem/rust-cache@v2
        with:
          key: mcp-linux

      - name: Install aarch64 cross-compile toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build Linux binaries
        run: |
          cargo build --release --manifest-path src-mcp/Cargo.toml --target x86_64-unknown-linux-gnu
          cargo build --release --manifest-path src-mcp/Cargo.toml --target aarch64-unknown-linux-gnu
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc

      - name: Stage binaries
        run: |
          mkdir -p bins/linux_amd64 bins/linux_arm64
          cp target/x86_64-unknown-linux-gnu/release/fotos-mcp bins/linux_amd64/fotos-mcp
          cp target/aarch64-unknown-linux-gnu/release/fotos-mcp bins/linux_arm64/fotos-mcp

      - uses: actions/upload-artifact@v4
        with:
          name: bins-linux
          path: bins/
          retention-days: 1

  mcp-darwin:
    name: Build fotos-mcp (macOS)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - uses: Swatinem/rust-cache@v2
        with:
          key: mcp-darwin

      - name: Build macOS binaries
        run: |
          cargo build --release --manifest-path src-mcp/Cargo.toml --target x86_64-apple-darwin
          cargo build --release --manifest-path src-mcp/Cargo.toml --target aarch64-apple-darwin

      - name: Stage binaries
        run: |
          mkdir -p bins/darwin_amd64 bins/darwin_arm64
          cp target/x86_64-apple-darwin/release/fotos-mcp bins/darwin_amd64/fotos-mcp
          cp target/aarch64-apple-darwin/release/fotos-mcp bins/darwin_arm64/fotos-mcp

      - uses: actions/upload-artifact@v4
        with:
          name: bins-darwin
          path: bins/
          retention-days: 1

  mcp-windows:
    name: Build fotos-mcp (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - uses: Swatinem/rust-cache@v2
        with:
          key: mcp-windows

      - name: Build Windows binary
        run: cargo build --release --manifest-path src-mcp/Cargo.toml --target x86_64-pc-windows-msvc

      - name: Stage binaries
        shell: bash
        run: |
          mkdir -p bins/windows_amd64
          cp target/x86_64-pc-windows-msvc/release/fotos-mcp.exe bins/windows_amd64/fotos-mcp.exe

      - uses: actions/upload-artifact@v4
        with:
          name: bins-windows
          path: bins/
          retention-days: 1

# ── fotos desktop app: Tauri builds ───────────────────────────────────────────

  build-linux:
    name: Build fotos (Linux)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev libwebkit2gtk-4.1-dev libjavascriptcoregtk-4.1-dev \
            libsoup-3.0-dev libcairo2-dev libpango1.0-dev libgdk-pixbuf-2.0-dev \
            libatk1.0-dev libappindicator3-dev libdbus-1-dev libpipewire-0.3-dev \
            libclang-dev libssl-dev libtesseract-dev libleptonica-dev \
            librsvg2-dev libgbm-dev

      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Install tauri-cli
        run: cargo install tauri-cli --locked

      - name: Build package
        run: |
          triple=$(rustc -vV | grep '^host:' | cut -d' ' -f2)
          touch "src-tauri/fotos-mcp-${triple}"
          cargo tauri build --bundles deb,appimage

      - uses: actions/upload-artifact@v4
        with:
          name: linux-deb
          path: target/release/bundle/deb/*.deb

      - uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: target/release/bundle/appimage/*.AppImage

  build-windows:
    name: Build fotos (Windows)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2

      - name: Install LLVM and Clang
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: "17"

      - name: Cache vcpkg packages
        uses: actions/cache@v4
        id: vcpkg-cache
        with:
          path: C:\vcpkg\installed
          key: vcpkg-tesseract-x64-windows-static-md-v1

      - name: Install tesseract via vcpkg
        if: steps.vcpkg-cache.outputs.cache-hit != 'true'
        run: |
          vcpkg install tesseract:x64-windows-static-md leptonica:x64-windows-static-md
        env:
          VCPKG_ROOT: C:\vcpkg

      - name: Install tauri-cli
        run: cargo install tauri-cli --locked

      - name: Build package
        shell: bash
        run: |
          touch "src-tauri/fotos-mcp-x86_64-pc-windows-msvc.exe"
          cargo tauri build --bundles msi,nsis
        env:
          VCPKG_ROOT: C:\vcpkg
          TESSERACT_PREFIX: C:\vcpkg\installed\x64-windows-static-md

      - uses: actions/upload-artifact@v4
        with:
          name: windows-msi
          path: target/release/bundle/msi/*.msi

      - uses: actions/upload-artifact@v4
        with:
          name: windows-nsis
          path: target/release/bundle/nsis/*.exe

# ── publish: create GitHub release, update tap/bucket ─────────────────────────

  publish:
    name: Publish Release
    needs: [mcp-linux, mcp-darwin, mcp-windows, build-linux, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          pattern: bins-*
          path: bins/
          merge-multiple: true

      - uses: actions/download-artifact@v4
        with:
          pattern: "linux-*"
          path: artifacts/

      - uses: actions/download-artifact@v4
        with:
          pattern: "windows-*"
          path: artifacts/

      - name: Package fotos-mcp archives and checksums
        id: pkg
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          mkdir -p dist
          tar -czf "dist/fotos-mcp_${VERSION}_linux_amd64.tar.gz"  -C bins/linux_amd64  fotos-mcp
          tar -czf "dist/fotos-mcp_${VERSION}_linux_arm64.tar.gz"  -C bins/linux_arm64  fotos-mcp
          tar -czf "dist/fotos-mcp_${VERSION}_darwin_amd64.tar.gz" -C bins/darwin_amd64 fotos-mcp
          tar -czf "dist/fotos-mcp_${VERSION}_darwin_arm64.tar.gz" -C bins/darwin_arm64 fotos-mcp
          (cd bins/windows_amd64 && zip "$(pwd)/../../dist/fotos-mcp_${VERSION}_windows_amd64.zip" fotos-mcp.exe)
          cd dist && sha256sum *.tar.gz *.zip > checksums.txt

      - name: Create GitHub release
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${{ steps.pkg.outputs.version }}"
          PRERELEASE=""
          [[ "${TAG}" == *-* ]] && PRERELEASE="--prerelease"
          gh release create "${TAG}" \
            --title "${TAG}" \
            --generate-notes \
            $PRERELEASE \
            dist/fotos-mcp_${VERSION}_linux_amd64.tar.gz \
            dist/fotos-mcp_${VERSION}_linux_arm64.tar.gz \
            dist/fotos-mcp_${VERSION}_darwin_amd64.tar.gz \
            dist/fotos-mcp_${VERSION}_darwin_arm64.tar.gz \
            dist/fotos-mcp_${VERSION}_windows_amd64.zip \
            dist/checksums.txt \
            artifacts/linux-deb/*.deb \
            artifacts/linux-appimage/*.AppImage \
            artifacts/windows-msi/*.msi \
            artifacts/windows-nsis/*.exe
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew formula (fotos-mcp)
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${{ steps.pkg.outputs.version }}"
          git clone "https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/charly-vibes/homebrew-charly.git" /tmp/tap
          python3 scripts/update-homebrew-mcp.py \
            /tmp/tap/Formula/fotos-mcp.rb \
            "${VERSION}" "${TAG}" dist/checksums.txt
          cd /tmp/tap
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          git add Formula/fotos-mcp.rb
          git diff --staged --quiet || git commit -m "Update fotos-mcp to ${VERSION}"
          git push

      - name: Update Scoop manifest (fotos-mcp)
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${{ steps.pkg.outputs.version }}"
          git clone "https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/charly-vibes/scoop-charly.git" /tmp/scoop
          python3 scripts/update-scoop-mcp.py \
            /tmp/scoop/bucket/fotos-mcp.json \
            "${VERSION}" "${TAG}" dist/checksums.txt
          cd /tmp/scoop
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          git add bucket/fotos-mcp.json
          git diff --staged --quiet || git commit -m "Update fotos-mcp to ${VERSION}"
          git push

      - name: Update Homebrew cask (fotos)
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${{ steps.pkg.outputs.version }}"
          APPIMAGE=$(ls artifacts/linux-appimage/*.AppImage | head -1)
          APPIMAGE_SHA=$(sha256sum "$APPIMAGE" | awk '{print $1}')
          git clone "https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/charly-vibes/homebrew-charly.git" /tmp/tap-cask
          python3 scripts/update-homebrew-cask.py \
            /tmp/tap-cask/Casks/fotos.rb \
            "${VERSION}" "${TAG}" "${APPIMAGE_SHA}"
          cd /tmp/tap-cask
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          git add Casks/fotos.rb
          git diff --staged --quiet || git commit -m "Update fotos cask to ${VERSION}"
          git push

      - name: Update Scoop manifest (fotos desktop)
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${{ steps.pkg.outputs.version }}"
          MSI=$(ls artifacts/windows-msi/*.msi | head -1)
          MSI_SHA=$(sha256sum "$MSI" | awk '{print $1}')
          git clone "https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/charly-vibes/scoop-charly.git" /tmp/scoop-desktop
          python3 scripts/update-scoop-desktop.py \
            /tmp/scoop-desktop/bucket/fotos.json \
            "${VERSION}" "${TAG}" "${MSI_SHA}"
          cd /tmp/scoop-desktop
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          git add bucket/fotos.json
          git diff --staged --quiet || git commit -m "Update fotos to ${VERSION}"
          git push
